.docker_image_builder_job:
  variables:
    DOCKER_BUILDKIT: 1
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  image: docker:20.10.10
  services:
    - docker:20.10.10-dind

  before_script:
    - apk update && apk add bash git ca-certificates curl

.docker_image_cleanup_job:
  extends: .docker_image_builder_job

  variables:
    REGISTRY: $CI_REGISTRY_IMAGE
    REGISTRY_USER: ""
    REGISTRY_PASS: ""
    IMAGE_TAG: ""

    REG_SHA256: ade837fc5224acd8c34732bf54a94f579b47851cc6a7fd5899a98386b782e228
    REG_VERSION: 0.16.1

  before_script:
    - !reference [.docker_image_builder_job, before_script]
    - curl --fail --show-error --location "https://github.com/genuinetools/reg/releases/download/v$REG_VERSION/reg-linux-amd64" --output /usr/local/bin/reg
    - echo "$REG_SHA256  /usr/local/bin/reg" | sha256sum -c -
    - chmod a+x /usr/local/bin/reg

  script:
    - /usr/local/bin/reg rm -d --auth-url $REGISTRY -u $REGISTRY_USER -p $REGISTRY_PASS $IMAGE_TAG

.prepare_hived_data_5m_image:
  extends: .docker_image_builder_job

  variables:
    SUBMODULE_DIR: "$CI_PROJECT_DIR"
    REGISTRY_USER: "$CI_IMG_BUILDER_USER"
    REGISTRY_PASS: $CI_IMG_BUILDER_PASSWORD

    SCRIPTS_PATH: "$SUBMODULE_DIR/scripts"
  script:
    - $SCRIPTS_PATH/ci-helpers/get_image4submodule.sh "$SUBMODULE_DIR" registry.gitlab.syncad.com/hive/hive/ "HIVED_IMAGE_NAME" "$REGISTRY_USER" "$REGISTRY_PASS"

  artifacts:
    reports:
      dotenv: docker_image_name.env
    expire_in: 6 hours
